name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
          - beta
          - alpha
      dry_run:
        description: 'Dry run (no publish or push)'
        type: boolean
        default: false

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: npm ci

      - name: Bump version with standard-version
        id: version
        run: |
          # Determine the release command based on version type
          if [[ "${{ inputs.version }}" == "beta" ]]; then
            npm run release:beta
          elif [[ "${{ inputs.version }}" == "alpha" ]]; then
            npm run release:alpha
          else
            npm run release:${{ inputs.version }}
          fi

          # Extract the new version
          NEW_VERSION=$(node -p "require('./packages/frostpane/package.json').version")
          echo "new_version=v$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "version_number=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Bumped version to v$NEW_VERSION"

      - name: Validate version consistency
        run: npm run validate-versions

      - name: Build library
        run: npm run build:lib

      - name: Verify build artifacts
        run: |
          echo "Checking build artifacts..."
          test -f packages/frostpane/dist/frostpane.css || (echo "‚ùå frostpane.css not found" && exit 1)
          test -f packages/frostpane/dist/frostpane-core.css || (echo "‚ùå frostpane-core.css not found" && exit 1)
          test -f packages/frostpane/dist/frostpane.unminified.css || (echo "‚ùå frostpane.unminified.css not found" && exit 1)
          test -f packages/frostpane/dist/frostpane-core.unminified.css || (echo "‚ùå frostpane-core.unminified.css not found" && exit 1)
          echo "‚úÖ All build artifacts present"

      - name: Build example site
        run: npm run build:example

      - name: Verify example build
        run: |
          echo "Checking example site build artifacts..."
          test -d packages/example/dist || (echo "‚ùå Example dist directory not found" && exit 1)
          test -f packages/example/dist/index.html || (echo "‚ùå index.html not found" && exit 1)
          test -d packages/example/dist/assets || (echo "‚ùå assets directory not found" && exit 1)
          # Verify at least one CSS file exists in assets
          ls packages/example/dist/assets/*.css >/dev/null 2>&1 || (echo "‚ùå No CSS files found in assets" && exit 1)
          echo "‚úÖ Example site built successfully"

      - name: Push changes
        if: ${{ !inputs.dry_run }}
        id: push
        run: |
          git push --follow-tags origin main
          echo "‚úÖ Changes pushed to remote"
        continue-on-error: true

      - name: Rollback on push failure
        if: steps.push.outcome == 'failure'
        run: |
          echo "‚ùå Push failed, rolling back..."
          git tag -d ${{ steps.version.outputs.new_version }}
          git reset --hard HEAD~1
          exit 1

      - name: Publish to npm
        if: ${{ !inputs.dry_run }}
        id: publish
        run: |
          cd packages/frostpane
          npm publish --provenance --access public
          echo "‚úÖ Published to npm"
        continue-on-error: true

      - name: Rollback on publish failure
        if: steps.publish.outcome == 'failure'
        run: |
          echo "‚ùå npm publish failed, rolling back..."
          git push origin :refs/tags/${{ steps.version.outputs.new_version }}
          git tag -d ${{ steps.version.outputs.new_version }}
          git revert HEAD --no-edit
          git push origin main
          echo "‚ö†Ô∏è Please manually deprecate the npm version if it was published"
          exit 1

      - name: Extract changelog for release
        if: ${{ !inputs.dry_run }}
        id: changelog
        run: |
          # Extract the latest version's changelog
          VERSION="${{ steps.version.outputs.version_number }}"

          # Get changelog content between the latest version and the previous one
          CHANGELOG=$(awk "/## \[$VERSION\]/,/## \[/" CHANGELOG.md | sed '$d' | tail -n +2)

          # If extraction failed, use a default message
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="See [CHANGELOG.md](https://github.com/cameronrye/frostpane/blob/main/CHANGELOG.md) for details."
          fi

          # Save to file for multiline output
          echo "$CHANGELOG" > /tmp/changelog.txt
          echo "changelog_file=/tmp/changelog.txt" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        if: ${{ !inputs.dry_run }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.new_version }}"
          VERSION_NUMBER="${{ steps.version.outputs.version_number }}"

          # Determine if this is a prerelease
          PRERELEASE_FLAG=""
          if [[ "$VERSION_NUMBER" == *"beta"* ]] || [[ "$VERSION_NUMBER" == *"alpha"* ]]; then
            PRERELEASE_FLAG="--prerelease"
          fi

          # Create release with changelog
          gh release create "$VERSION" \
            --title "Release $VERSION" \
            --notes-file "${{ steps.changelog.outputs.changelog_file }}" \
            $PRERELEASE_FLAG \
            --latest

          echo "‚úÖ GitHub release created"

      - name: Dry run summary
        if: ${{ inputs.dry_run }}
        run: |
          echo "üîç DRY RUN COMPLETE"
          echo "Version would be bumped to: ${{ steps.version.outputs.new_version }}"
          echo "Changes would be committed and tagged"
          echo "Package would be published to npm"
          echo "GitHub release would be created"
          echo ""
          echo "To perform the actual release, run this workflow again with dry_run=false"

